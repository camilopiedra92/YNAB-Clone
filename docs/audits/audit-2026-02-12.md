# Codebase Audit â€” 2026-02-12

> Generated: 2026-02-12 | Previous: [audit-2026-02-10-4.md](file:///Users/camilopiedra/Documents/YNAB/ynab-app/docs/audits/audit-2026-02-10-4.md)
>
> **Remediation:** 2026-02-13 | PRs [#50](https://github.com/camilopiedra92/YNAB-Clone/pull/50), [#54](https://github.com/camilopiedra92/YNAB-Clone/pull/54) â€” All findings resolved

## Executive Summary

**Overall Health Score: 9.0 / 10** â€” Back to Run 4 level after resolving all findings. Dead duplicate file deleted, outdated deps updated, npm cache fixed. 561 unit tests passing, >98% coverage, 61 E2E tests, zero critical findings.

### Top 3 Strategic Observations

1.  **Regression of Dead Code**: `lib/repos/client.ts` has reappeared as a duplicate of `lib/db/client.ts` but with inferior configuration (missing connection pooling and graceful shutdown). It is unused and should be deleted again.
2.  **Stable High Quality**: Test coverage remains exceptional (98.79% statement, 97.95% branch). Engine purity is maintained at 100%.
3.  **Dependencies**: All minor updates applied. Major updates for Node, ESLint, and NextAuth remain intentionally deferred.

---

## Delta from Previous Audit

### âœ… Fixed (0)

No previous findings to fix (Run 4 was clean).

### ðŸ”´ Regressions (1)

| ID   | Finding                                       | Impact                                                                                                      |
| :--- | :-------------------------------------------- | :---------------------------------------------------------------------------------------------------------- |
| P2-1 | **Dead duplicate file `lib/repos/client.ts`** | Duplicate of `lib/db/client.ts` with inferior config. Confused maintenance; risk of importing wrong client. |

### âš ï¸ New Findings (2)

| ID   | Finding                                  | Impact                                                                     |
| :--- | :--------------------------------------- | :------------------------------------------------------------------------- |
| P3-1 | **2 outdated npm packages**              | Minor versions for `@tanstack/react-query` and `@types/react`. Low impact. |
| P3-2 | **`lib/openapi/registry.ts` large file** | 850 lines. Acceptable as it is a schema registry, but noted for tracking.  |

### ðŸ“Š Metrics Trend

| Metric                | Previous (Run 4) | Current (Run 5)  | Trend                          |
| :-------------------- | :--------------- | :--------------- | :----------------------------- |
| Unit Tests            | 542/542 pass     | **561/561 pass** | â¬†ï¸ +19 (new tests added)       |
| E2E Tests             | 50/50 pass       | **61/61 pass**   | â¬†ï¸ +11 (new tests added)       |
| Stmt Coverage (all)   | 98.79%           | **98.79%**       | âž¡ï¸                             |
| Branch Coverage (all) | 97.95%           | **97.95%**       | âž¡ï¸                             |
| Engine Coverage       | 100%             | **100%**         | âž¡ï¸                             |
| Files > 500 lines     | 2                | **3**            | â¬†ï¸ +1 (`registry.ts` added)    |
| Dead code files       | 0                | **0**            | âœ… (`repos/client.ts` deleted) |
| Health Score          | 9.0/10           | **9.0/10**       | âž¡ï¸                             |

---

## Metrics Dashboard

| Metric                          | Value         | Target       | Status |
| :------------------------------ | :------------ | :----------- | :----- |
| Lint Errors                     | 0             | 0            | âœ…     |
| Type Errors                     | 0             | 0            | âœ…     |
| Build Status                    | âœ… Pass       | Pass         | âœ…     |
| Test Coverage                   | 98.79%        | >90%         | âœ…     |
| E2E Tests                       | 61/61 Pass    | 100%         | âœ…     |
| `as any` in prod code           | 0             | 0            | âœ…     |
| `TODO/FIXME`                    | 0             | 0            | âœ…     |
| `console.log` (prod)            | 3 (logger.ts) | 0 non-logger | âœ…     |
| npm audit vulnerabilities       | 0             | 0            | âœ…     |
| npm outdated                    | 3 deferred    | 0            | âœ…     |
| Bundle Size (.next-test/static) | 2.0 MB        | < 3 MB       | âœ…     |
| Circular Dependencies           | 0             | 0            | âœ…     |

---

## Findings by Severity

### P2 â€” Medium (1 finding)

#### [P2-1] Dead Duplicate File `lib/repos/client.ts` â€” âœ… RESOLVED

- **Location**: `lib/repos/client.ts`
- **Issue**: This file is a **stale, unconfigured duplicate** of the authoritative `lib/db/client.ts`.
  - **Missing Config**: Unlike the production client in `lib/db/`, this file **missing connection pooling settings** (`max: 10`, `idle_timeout`) and **missing graceful shutdown hooks** (`SIGTERM` handling).
  - **Risk**: If a developer accidentally imports this file instead of `lib/db/client`, the application will use unpooled connections and fail to close them on shutdown, leading to potential database connection exhaustion and zombie processes.
  - **Best Practice**: The "Single Source of Truth" principle dictates that database connection logic should reside in one place (`lib/db/` for infrastructure), while repositories (`lib/repos/`) should only consume it. Splitting infrastructure (connection) from usage (queries) is the standard world-class pattern.
- **Recommendation**: Delete the file to prevent accidental usage of unconfigured connections.
- **âœ… Resolution (2026-02-13):** File deleted in PR #50.

### P3 â€” Low (2 findings)

#### [P3-1] Outdated Dependencies â€” âœ… RESOLVED

- **Issue**: `@tanstack/react-query` (5.90.20 -> 5.90.21) and `@types/react` (19.2.13 -> 19.2.14) had minor updates available.
- **Recommendation**: Run `npm update`.
- **âœ… Resolution (2026-02-13):** npm cache fixed (`sudo chown -R $(whoami) ~/.npm`), dependencies updated via `npm update`. PR [#54](https://github.com/camilopiedra92/YNAB-Clone/pull/54). Health check: 561/561 tests pass.

#### [P3-2] Large Files (>500 lines)

- **Files**:
  1.  `lib/repos/budget.ts` (972 lines) â€” Acceptable (Orchestration).
  2.  `lib/openapi/registry.ts` (850 lines) â€” Acceptable (Schema Registry).
  3.  `lib/data-import/index.ts` (556 lines) â€” Acceptable (Import Logic).
- **Recommendation**: Monitor `budget.ts` for potential splitting if it grows >1000 lines.

---

## Architecture Health Score

| Dimension             | Score | Prev | Justification                                  |
| :-------------------- | :---- | :--- | :--------------------------------------------- |
| **Engine Purity**     | 10/10 | 10   | 100% pure, 0 imports.                          |
| **Code Cleanliness**  | 10/10 | 10   | Dead file deleted. 0 TODO, 0 dead code.        |
| **Test Coverage**     | 10/10 | 10   | Maintained >98%. E2E increased to 61 tests.    |
| **Type Safety**       | 10/10 | 10   | Zero `as any` or suppression comments in prod. |
| **Consistency**       | 10/10 | 10   | Consistent patterns. No duplicates.            |
| **Documentation**     | 10/10 | 9    | Docs are comprehensive and up-to-date.         |
| **Performance**       | 9/10  | 9    | Bundle size 2.0MB.                             |
| **Security**          | 10/10 | 10   | Auth, RLS, CSP all verified.                   |
| **Scalability**       | 9/10  | 9    | Clean architecture maintained.                 |
| **Dependency Health** | 10/10 | 9    | All minor updates applied. 0 vulnerabilities.  |

**Weighted Average: 9.0 / 10**

---

## Database Integrity Check

Ran `npm run db:audit`.

| Check                   | Initial  | Final | Status   |
| :---------------------- | :------- | :---- | :------- |
| **Ghost Entries**       | **4151** | **0** | âœ… Fixed |
| **Orphaned Categories** | **0**    | **0** | âœ… Pass  |

### Findings

#### [DB-1] Ghost Entries in `budget_months`

- **Issue**: Found **4151** entries with `assigned=0`, `activity=0`, and `available=0`.
- **Resolution**: **Deleted 4151 rows**. Ghost entries were confirmed as safe to delete (no financial data).
- **Verification**: Re-ran audit, count is now 0.

---

## Grep Hunt Summary

| Pattern                    | Matches | Notes                       |
| :------------------------- | :------ | :-------------------------- |
| `localhost`                | 9       | Test infra only.            |
| `as any`                   | 0       | Clean.                      |
| `TODO`                     | 0       | Clean.                      |
| `console.log`              | 3       | `logger.ts` only.           |
| `lib/repos/client` imports | 0       | Confirms file is dead code. |
