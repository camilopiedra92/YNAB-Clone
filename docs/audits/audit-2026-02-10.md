# Codebase Audit — 2026-02-10

> Generated: 2026-02-10 16:10 EST | Previous: First audit

## Executive Summary

**Overall Health Score: 8.2 / 10** — The codebase is in excellent shape. The financial engine is pure and well-tested (100% branch coverage on all modules except the new `clock.ts`), all API routes use proper auth guards, no inline financial math leaks, no `as any` in production code, and zero TODO/FIXME/HACK markers remain. The main areas for improvement are: (1) one oversized page component at 993 lines, (2) a few `eslint-disable` pragmas in production code that could be removed with proper typing, (3) `.env.example` is incomplete, (4) engine test coverage threshold fails due to untested `clock.ts`, and (5) hardcoded E2E test URLs.

### Top 5 Strategic Recommendations

1. **Split `budget/page.tsx`** — at 993 lines it's the largest file and violates the <500-line rule. Extract the DnD logic, header, and filter bar into separate components.
2. **Add `clock.ts` tests** — 0% coverage breaks the engine threshold gate. These are trivial pure functions (4 functions, 38 lines).
3. **Type the DnD cache updates** — 3 `eslint-disable @typescript-eslint/no-explicit-any` suppression comments in `budget/page.tsx` exist because `queryClient.setQueryData` uses `any` for the old value. Use the existing `BudgetResponseDTO` type instead.
4. **Complete `.env.example`** — missing `AUTH_SECRET`, and `NODE_ENV` should not be in `.env` per project rules.
5. **Fix anti-pattern scanner path bug** — the `--all` scan looks for `ynab-app/app` instead of `./app`, making it non-functional.

---

## Metrics Dashboard

| Metric                            | Value                | Target       | Status                       |
| --------------------------------- | -------------------- | ------------ | ---------------------------- |
| ESLint                            | 0 errors, 0 warnings | 0            | ✅                           |
| TypeScript                        | 0 errors             | 0            | ✅                           |
| Production Build                  | ✅ passes            | pass         | ✅                           |
| Unit Tests                        | 515/515 pass         | 100%         | ✅                           |
| E2E Tests                         | 50/50 pass           | 100%         | ✅                           |
| Stmt Coverage (all)               | 97.69%               | 90%          | ✅                           |
| Branch Coverage (all)             | 97.93%               | 90%          | ✅                           |
| Engine Stmt Coverage              | 94.21%               | 100%         | ❌ (`clock.ts` = 0%)         |
| Engine Branch Coverage            | 100%                 | 100%         | ✅                           |
| Engine Func Coverage              | 87.5%                | 100%         | ❌ (`clock.ts` = 0%)         |
| `as any` in prod code             | 0                    | 0            | ✅                           |
| `@ts-ignore` / `@ts-expect-error` | 0                    | 0            | ✅                           |
| TODO/FIXME/HACK                   | 0                    | 0            | ✅                           |
| `eslint-disable` (prod code)      | 7 instances          | 0            | ⚠️                           |
| `eslint-disable` (test code)      | 10 instances         | —            | ℹ️ acceptable                |
| `console.log` in prod code        | 3 (logger.ts)        | 0 non-logger | ✅                           |
| npm audit vulnerabilities         | 4 moderate           | 0            | ⚠️                           |
| Files > 500 lines                 | 3                    | 0            | ⚠️                           |
| Circular dependencies             | —                    | 0            | ⬜ (madge failed to install) |
| `.next-test/static` bundle        | 2.0 MB               | —            | ✅                           |
| Commented-out code                | 1 instance           | 0            | ⚠️                           |
| Hardcoded secrets                 | 0                    | 0            | ✅                           |
| SQL injection vectors             | 0                    | 0            | ✅                           |

---

## Findings by Severity

### P0 — Critical (0 findings)

No critical issues found. All budget routes have `requireBudgetAccess`, the engine is pure (zero DB/HTTP/React imports), no `as any` in production code, no inline financial math outside the engine, and all error responses use `apiError()`.

---

### P1 — High (3 findings)

#### P1-1: Engine test coverage threshold fails — `clock.ts` at 0%

- **File:** [clock.ts](file:///Users/camilopiedra/Documents/YNAB/ynab-app/lib/engine/clock.ts)
- **Impact:** The `npm run test:coverage` gate fails with `ERROR: Coverage for statements (94.21%) does not meet "lib/engine/**" threshold (100%)`. This blocks CI enforcement of the 100% engine coverage rule.
- **Why:** `clock.ts` exports 4 pure functions (`getCurrentMonth`, `isPastMonth`, `isCurrentMonth`, `isFutureMonth`) that have zero test coverage. These are simple string comparisons against `new Date()`.
- **Fix:** Add ~10-line unit test file `lib/__tests__/clock.test.ts` covering all 4 functions. Use `vi.useFakeTimers()` to control `Date.now()`.
- **Effort:** S (<30 min)
- **Rule:** Violates Rule 05 §5 ("Write unit tests for new engine functions")

#### P1-2: `budget/page.tsx` at 993 lines — far exceeds 500-line limit

- **File:** [page.tsx](<file:///Users/camilopiedra/Documents/YNAB/ynab-app/app/(app)/budgets/[budgetId]/budget/page.tsx>)
- **Impact:** Hard to maintain, hard to test, violates the Phase 10 complexity rule. Contains the full DnD logic (~250 lines), header/filters (~100 lines), toolbar, and the main table rendering all in one component.
- **Fix:** Extract into:
  - `BudgetDndContext.tsx` — all DnD handlers (`onDragStart`, `onDragOver`, `onDragEnd`)
  - `BudgetHeader.tsx` — month navigation, RTA widget, view toggle
  - `BudgetFilters.tsx` — filter bar, undo/redo, search
  - Keep `BudgetPage` as a thin orchestrator (~200 lines)
- **Effort:** L (half day)
- **Rule:** Violates Phase 10 "No file >500 lines"

#### P1-3: `.env.example` incomplete and contains `NODE_ENV`

- **File:** [.env.example](file:///Users/camilopiedra/Documents/YNAB/ynab-app/.env.example)
- **Impact:** New developers won't know `AUTH_SECRET` is required (validated by Zod with `.min(32)`). `NODE_ENV=development` in `.env` is an anti-pattern — it should be set by the runtime, not the dotenv file.
- **Current contents:**
  ```
  DATABASE_URL=postgresql://localhost:5432/ynab_dev
  NODE_ENV=development
  PORT=3000
  ```
- **Fix:** Add `AUTH_SECRET=<generate-a-32-char-secret>` with a comment. Remove `NODE_ENV` line. Add `AUTH_TRUST_HOST=true` for local dev.
- **Effort:** S (<30 min)
- **Rule:** Violates Phase 3.8 "`.env.example` current"

---

### P2 — Medium (6 findings)

#### P2-1: 3 `eslint-disable @typescript-eslint/no-explicit-any` in `budget/page.tsx` DnD code

- **Files:** [page.tsx:374](<file:///Users/camilopiedra/Documents/YNAB/ynab-app/app/(app)/budgets/[budgetId]/budget/page.tsx#L374>), [L444](<file:///Users/camilopiedra/Documents/YNAB/ynab-app/app/(app)/budgets/[budgetId]/budget/page.tsx#L444>), [L509](<file:///Users/camilopiedra/Documents/YNAB/ynab-app/app/(app)/budgets/[budgetId]/budget/page.tsx#L509>)
- **Impact:** Type safety gap. These suppress `any` on `queryClient.setQueryData` callbacks during DnD reorder.
- **Fix:** Use `queryClient.setQueryData<BudgetResponseDTO>(...)` (the type is already imported in `useBudgetMutations.ts`).
- **Effort:** S (<30 min)

#### P2-2: `SortableRow.tsx` has file-level `eslint-disable @typescript-eslint/no-explicit-any`

- **File:** [SortableRow.tsx](file:///Users/camilopiedra/Documents/YNAB/ynab-app/components/budget/SortableRow.tsx#L1)
- **Impact:** `children: (listeners: any, attributes: any) => ReactNode` and `[key: string]: any` lose type safety.
- **Fix:** Import `SyntheticListenerMap` from `@dnd-kit/core` and `DraggableAttributes` from `@dnd-kit/core/dist/hooks`. Use a stricter props type instead of `[key: string]: any`.
- **Effort:** S (<30 min)

#### P2-3: `Sidebar.tsx` has file-level `eslint-disable @typescript-eslint/no-unused-vars`

- **File:** [Sidebar.tsx:1](file:///Users/camilopiedra/Documents/YNAB/ynab-app/components/Sidebar.tsx#L1)
- **Impact:** Dead code masking. The `mainNavigation` constant (lines 32-36) appears unused — it's replaced by the inline navigation array on line 210.
- **Fix:** Remove the `mainNavigation` constant and the eslint-disable pragma.
- **Effort:** S (<30 min)

#### P2-4: `data-import/index.ts` has file-level `eslint-disable @typescript-eslint/no-unused-vars`

- **File:** [index.ts:1](file:///Users/camilopiedra/Documents/YNAB/ynab-app/lib/data-import/index.ts#L1)
- **Impact:** Same pattern — may mask actual dead code. Should identify which vars are unused and either use them or remove them.
- **Fix:** Remove the pragma, run lint, and fix individual unused vars.
- **Effort:** S (<30 min)

#### P2-5: Commented-out code in `useBudgetMutations.ts`

- **File:** [useBudgetMutations.ts:107](file:///Users/camilopiedra/Documents/YNAB/ynab-app/hooks/useBudgetMutations.ts#L107)
- **Content:** `// const prevAvailable = existing ? existing.available - existing.assigned : 0;`
- **Impact:** Dead code that adds clutter. This was replaced by the engine-powered carryforward calculation.
- **Fix:** Delete the commented-out line.
- **Effort:** S (<30 min)

#### P2-6: Anti-pattern scanner script has path bug on `--all` mode

- **File:** [scan-antipatterns.sh:47](file:///Users/camilopiedra/Documents/YNAB/ynab-app/.agent/skills/code-review/scripts/scan-antipatterns.sh#L47)
- **Impact:** The `--all` scan mode is broken. It looks for `ynab-app/app` but the script already `cd`s into the project root, so paths should be `./app`, `./hooks`, `./lib`, `./components`.
- **Fix:** Change `find ynab-app/app ynab-app/hooks ...` to `find ./app ./hooks ./lib ./components`.
- **Effort:** S (<30 min)

---

### P3 — Low (4 findings)

#### P3-1: 4 moderate npm vulnerabilities (esbuild via drizzle-kit)

- **Source:** `npm audit`
- **Detail:** esbuild has a moderate severity advisory (GHSA-67mh-4wv8-2f99: dev server allows cross-origin reads). It's a transitive dep of `drizzle-kit` → `@esbuild-kit/esm-loader` → `@esbuild-kit/core-utils` → `esbuild`. No fix available.
- **Impact:** Development-only risk. Does not affect production builds.
- **Fix:** Wait for drizzle-kit to update its dep chain. Consider pinning or overriding if security policy requires.
- **Effort:** S (monitor)

#### P3-2: Hardcoded `localhost:3001` in E2E test files

- **Files:** `tests/data-import.spec.ts:120,156`, `tests/budget-selection.spec.ts:15`, `tests/auth.spec.ts:17`
- **Impact:** Duplicates `TEST_BASE_URL` from `test-constants.ts`. If the port changes, these tests break.
- **Fix:** Import `TEST_BASE_URL` from `test-constants.ts` instead of hardcoding.
- **Effort:** S (<30 min)

#### P3-3: E2E `eslint-disable react-hooks/exhaustive-deps` in `useAnimatedNumber.ts` and `useDebouncedMutation.ts`

- **Files:** [useAnimatedNumber.ts:67](file:///Users/camilopiedra/Documents/YNAB/ynab-app/hooks/useAnimatedNumber.ts#L67), [useDebouncedMutation.ts:30,42](file:///Users/camilopiedra/Documents/YNAB/ynab-app/hooks/useDebouncedMutation.ts#L30)
- **Impact:** Intentional — these hooks deliberately exclude `displayValue`/`mutation` from deps to prevent infinite loops. The suppression is correct but should have a comment explaining WHY.
- **Fix:** Add a brief `// Intentionally excluding X to prevent Y` comment next to each suppression.
- **Effort:** S (<30 min)

#### P3-4: `UserRepoDeps` empty interface with eslint-disable

- **File:** [users.ts:5-8](file:///Users/camilopiedra/Documents/YNAB/ynab-app/lib/repos/users.ts#L5-L8)
- **Impact:** Minor — placeholder interface for future use. The eslint-disable is correct.
- **Fix:** Keep as-is, or remove the interface and use `Record<string, never>` if the lint rule is important.
- **Effort:** S (<30 min)

---

## Findings by Layer

### Engine (`lib/engine/`)

- ✅ Pure functions only — zero DB/HTTP/React/env deps confirmed
- ✅ `Milliunit` branded types used everywhere
- ✅ Types in `types.ts`, exports via `index.ts`
- ✅ 100% branch coverage (all modules except `clock.ts`)
- ❌ `clock.ts` has 0% coverage (P1-1)

### Repos (`lib/repos/`)

- ✅ query→engine→write pattern consistently applied
- ✅ No inline math — all financial calculations delegate to engine
- ✅ `AND date <= date('now')` on all date queries (verified in `budget.ts`, `accounts.ts`, `transactions.ts`)
- ✅ Ghost entry prevention in `updateBudgetAssignment()`
- ✅ Carryforward propagation on assignment changes
- ✅ 99.74% stmt coverage, 99.53% branch coverage

### API Routes (`app/api/`)

- ✅ All budget routes use `requireBudgetAccess()` (verified across 11 route files)
- ✅ All routes use Zod validation via schema helpers
- ✅ All error responses use `apiError()` helper (confirmed via grep: 0 bare `NextResponse.json.*error`)
- ✅ DTO transforms for all responses
- ✅ `await params` pattern used correctly
- ⚠️ `import/route.ts` imports `db` directly (acceptable — `importDataFromCSV` is a standalone module that takes `db` as a param)

### Hooks (`hooks/`)

- ✅ All mutations use `useMutation` with `mutationKey` and `meta`
- ✅ `useUpdateAssigned` has full snapshot/rollback pattern with engine-powered optimistic updates
- ✅ No direct `toast()` calls in mutation hooks
- ✅ `cancelQueries` → `onMutate`, `invalidateQueries` → `onSettled`
- ✅ Debounced inputs use `useDebouncedMutation`
- ⚠️ Commented-out code at L107 (P2-5)
- ⚠️ `useUpdateCategoryName` and `useReorderCategories` lack optimistic `onMutate` (acceptable — reorder is visually handled in page state, name change is fast)

### Components (`components/`)

- ✅ No business logic in components
- ✅ `data-testid` on interactive elements (`budget-table`, `rta-amount`, `month-*`, `sidebar-*`, `transaction-row-*`)
- ✅ Loading/error states present
- ⚠️ `SortableRow.tsx` uses `any` (P2-2)
- ⚠️ `Sidebar.tsx` has unused `mainNavigation` constant (P2-3)

### Database (`drizzle/`)

- ✅ Schema uses `bigint` columns for monetary values with `Milliunit` custom type
- ✅ Foreign keys defined with `onDelete: 'cascade'`
- ✅ SQL queries are parameterized (Drizzle ORM template literals — verified no string interpolation in SQL)

### Config & Environment

- ❌ `.env.example` missing `AUTH_SECRET` (P1-3)
- ❌ `.env.example` contains `NODE_ENV=development` (P1-3)
- ✅ No hardcoded secrets in source code
- ✅ `AUTH_SECRET` validated by Zod with `.min(32)` in `lib/env.ts`

---

## Architecture Health Score

| Dimension                  | Score | Justification                                                                                  |
| -------------------------- | ----- | ---------------------------------------------------------------------------------------------- |
| **Engine Purity**          | 10/10 | Zero impure imports confirmed. All financial math in `lib/engine/`.                            |
| **Auth / Security**        | 9/10  | All routes guarded. Rate limiting on auth/import. Missing CSRF docs.                           |
| **Type Safety**            | 8/10  | Zero `as any` in prod. `Milliunit` branded types enforced. 7 `eslint-disable` in prod.         |
| **Test Coverage**          | 9/10  | 97.69% stmt, 515 unit + 50 E2E. Only gap: `clock.ts`.                                          |
| **Separation of Concerns** | 7/10  | Engine ✅, Repos ✅, but `budget/page.tsx` is a god component.                                 |
| **Error Handling**         | 9/10  | Consistent `apiError()`. Global MutationCache toast. Snapshot/rollback.                        |
| **Documentation**          | 7/10  | Good README, arch docs, rules. `.env.example` incomplete. No CHANGELOG.                        |
| **Performance**            | 9/10  | Virtualized tables, memoized rows, debounced inputs, 2MB bundle.                               |
| **Code Cleanliness**       | 8/10  | 0 TODO, 0 dead code (except 1 line). Well-structured repos/hooks.                              |
| **Dependency Health**      | 7/10  | 4 moderate vulns (esbuild, dev only). `npm outdated`/`depcheck` failed due to npm cache perms. |
| **Consistency**            | 9/10  | Consistent patterns across routes, hooks, repos. Spanish UI strings.                           |
| **Scalability**            | 8/10  | Multi-tenant ready. Budget-scoped queries. Engine is portable.                                 |

**Weighted Average: 8.2 / 10**

---

## Proposed Fix Order

| #   | Finding                                           | Effort | Impact                           |
| --- | ------------------------------------------------- | ------ | -------------------------------- |
| 1   | P1-1: Add `clock.ts` tests                        | S      | Unblocks CI engine coverage gate |
| 2   | P1-3: Fix `.env.example`                          | S      | Prevents new dev setup failures  |
| 3   | P2-5: Remove commented-out code                   | S      | Cleanup                          |
| 4   | P2-6: Fix anti-pattern scanner paths              | S      | Restores `--all` scan mode       |
| 5   | P2-3: Remove unused `mainNavigation` in Sidebar   | S      | Cleanup, remove eslint-disable   |
| 6   | P2-1: Type DnD cache updates                      | S      | Remove 3 eslint-disable pragmas  |
| 7   | P2-2: Type `SortableRow.tsx` props                | S      | Remove file-level eslint-disable |
| 8   | P2-4: Clean `data-import` unused vars             | S      | Remove file-level eslint-disable |
| 9   | P3-2: Use `TEST_BASE_URL` constant in all E2E     | S      | DRY, prevent port drift          |
| 10  | P3-3: Add intent comments on hooks eslint-disable | S      | Self-documenting                 |
| 11  | P1-2: Split `budget/page.tsx`                     | L      | Maintainability, testability     |
| 12  | P3-1: Monitor esbuild vuln in drizzle-kit         | S      | Security hygiene                 |
