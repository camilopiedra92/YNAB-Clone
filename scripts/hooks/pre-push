#!/usr/bin/env bash
# Git pre-push hook
# Blocks direct pushes to protected branches (main).
# Layer 1 of defense-in-depth (Layer 2 = GitHub Rulesets).
#
# This hook runs BEFORE any push, regardless of how the commit was made
# (npm run git:sync, raw git commit, IDE commit, etc.)

set -euo pipefail

PROTECTED_BRANCH="main"

while read -r local_ref local_sha remote_ref remote_sha; do
    # Extract the remote branch name from refs/heads/...
    remote_branch="${remote_ref#refs/heads/}"

    if [ "$remote_branch" = "$PROTECTED_BRANCH" ]; then
        echo ""
        echo "ðŸš« BLOCKED: Direct push to '$PROTECTED_BRANCH' is not allowed."
        echo ""
        echo "   '$PROTECTED_BRANCH' only receives code via PR."
        echo "   Use the standard flow: feature branch â†’ PR â†’ staging â†’ PR â†’ main"
        echo ""
        echo "   To fix:"
        echo "   1. git reset HEAD~1              # undo the commit (keeps changes)"
        echo "   2. git checkout staging           # switch to staging"
        echo "   3. git checkout -b feat/my-fix    # create feature branch"
        echo "   4. git add . && npm run git:sync  # commit properly"
        echo ""
        exit 1
    fi
done

exit 0
