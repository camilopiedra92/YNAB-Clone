#!/usr/bin/env bash
# Git pre-push hook
# 1. Blocks direct pushes to protected branches (main).
#    Layer 1 of defense-in-depth (Layer 2 = GitHub Rulesets).
# 2. Runs unit tests before allowing the push.
#
# Bypass: git push --no-verify  OR  SKIP_HOOKS=1 git push
#
# This hook runs BEFORE any push, regardless of how the commit was made
# (npm run git:sync, raw git commit, IDE commit, etc.)

set -euo pipefail

# â”€â”€â”€ Skip mechanisms â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if [ "${SKIP_HOOKS:-}" = "1" ]; then
    echo "â­ï¸  pre-push: Skipped (SKIP_HOOKS=1)"
    exit 0
fi

if [ "${CI:-}" = "true" ]; then
    exit 0
fi

PROTECTED_BRANCH="main"

# â”€â”€â”€ 1. Branch protection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
while read -r local_ref local_sha remote_ref remote_sha; do
    # Extract the remote branch name from refs/heads/...
    remote_branch="${remote_ref#refs/heads/}"

    if [ "$remote_branch" = "$PROTECTED_BRANCH" ]; then
        echo ""
        echo "ğŸš« BLOCKED: Direct push to '$PROTECTED_BRANCH' is not allowed."
        echo ""
        echo "   '$PROTECTED_BRANCH' only receives code via PR."
        echo "   Use the standard flow: feature branch â†’ PR â†’ staging â†’ PR â†’ main"
        echo ""
        echo "   To fix:"
        echo "   1. git reset HEAD~1              # undo the commit (keeps changes)"
        echo "   2. git checkout staging           # switch to staging"
        echo "   3. git checkout -b feat/my-fix    # create feature branch"
        echo "   4. git add . && npm run git:sync  # commit properly"
        echo ""
        exit 1
    fi
done

# â”€â”€â”€ 2. Unit tests â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
REPO_ROOT="$(cd "$(dirname "$0")/../.." && pwd)"

echo "ğŸ§ª pre-push: Running unit tests..."
TEST_OUTPUT=$("$REPO_ROOT/scripts/with-local-tmp.sh" node --env-file="$REPO_ROOT/.env" "$REPO_ROOT/node_modules/vitest/vitest.mjs" run 2>&1) || {
    echo "$TEST_OUTPUT" | tail -30
    echo ""
    echo "âŒ Unit tests failed. Fix them before pushing."
    echo "   Bypass: git push --no-verify"
    exit 1
}
echo "âœ… Unit tests passed"

echo "ğŸ‰ pre-push: All checks passed"
