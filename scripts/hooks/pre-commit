#!/usr/bin/env bash
# Git pre-commit hook
# Runs lint (staged files only) + typecheck before every commit.
# Bypass: git commit --no-verify  OR  SKIP_HOOKS=1 git commit
#
# Installed automatically by `npm run git:install-hooks` (or `npm install` via prepare).

set -euo pipefail

# â”€â”€â”€ Skip mechanisms â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if [ "${SKIP_HOOKS:-}" = "1" ]; then
    echo "â­ï¸  pre-commit: Skipped (SKIP_HOOKS=1)"
    exit 0
fi

if [ "${CI:-}" = "true" ]; then
    exit 0
fi

REPO_ROOT="$(cd "$(dirname "$0")/../.." && pwd)"

# â”€â”€â”€ 1. Lint staged files â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Get staged .ts/.tsx/.js/.mjs files (exclude deleted files)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=d -- '*.ts' '*.tsx' '*.js' '*.mjs' || true)

if [ -n "$STAGED_FILES" ]; then
    echo "ğŸ” pre-commit: Linting staged files..."
    # shellcheck disable=SC2086
    if ! npx eslint --no-warn-ignored $STAGED_FILES; then
        echo ""
        echo "âŒ Lint errors found. Fix them before committing."
        echo "   Bypass: git commit --no-verify"
        exit 1
    fi
    echo "âœ… Lint passed"
else
    echo "â­ï¸  pre-commit: No lintable files staged"
fi

# â”€â”€â”€ 2. Typecheck (full project â€” TS needs type graph) â”€â”€â”€
echo "ğŸ” pre-commit: Running typecheck..."
TSC_OUTPUT=$(npx tsc --noEmit 2>&1) || {
    echo "$TSC_OUTPUT" | tail -30
    echo ""
    echo "âŒ TypeScript errors found. Fix them before committing."
    echo "   Bypass: git commit --no-verify"
    exit 1
}
echo "âœ… Typecheck passed"

echo "ğŸ‰ pre-commit: All checks passed"
