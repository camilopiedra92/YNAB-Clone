name: Deploy to Production

on:
  push:
    branches: [main]

concurrency:
  group: deploy-production
  cancel-in-progress: false # Never cancel an in-progress deploy

jobs:
  deploy:
    name: Trigger Coolify Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 5
    environment: production
    steps:
      - name: Trigger Coolify Webhook
        run: |
          if [ -z "${{ secrets.COOLIFY_WEBHOOK_URL }}" ]; then
            echo "âŒ COOLIFY_WEBHOOK_URL secret is not set"
            echo "Set it in GitHub â†’ Settings â†’ Secrets â†’ Actions"
            exit 1
          fi

          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
            -X GET "${{ secrets.COOLIFY_WEBHOOK_URL }}" \
            -H "Authorization: Bearer ${{ secrets.COOLIFY_API_TOKEN }}")

          if [ "$RESPONSE" = "200" ] || [ "$RESPONSE" = "201" ]; then
            echo "âœ… Deploy triggered successfully (HTTP $RESPONSE)"
          else
            echo "âŒ Deploy trigger failed (HTTP $RESPONSE)"
            exit 1
          fi

      - name: Deploy Summary
        run: |
          echo "## ðŸš€ Production Deploy" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Author:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** Triggered on Coolify" >> $GITHUB_STEP_SUMMARY
